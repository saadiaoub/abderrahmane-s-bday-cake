<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üéÇ Magical Birthday Cake</title>
<style>
  body { 
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    height: 100vh; background: #f0e6f6; font-family: 'Comic Sans MS', sans-serif; 
  }
  #cake {
    width: 300px; height: 180px;
    background: linear-gradient(to bottom, #4a90e2, #357ab7);
    border-radius: 0 0 40px 40px;
    box-shadow: inset -10px -10px 20px rgba(255,255,255,0.4),
                inset 10px 10px 20px rgba(0,0,0,0.3),
                0 15px 20px rgba(0,0,0,0.4);
    position: relative; margin-bottom: 20px;
    overflow: hidden;
  }
  #frosting {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 40px;
    background: linear-gradient(to bottom, #b3d9ff, #80bfff);
    border-radius: 50%;
    box-shadow: inset -5px -5px 10px rgba(255,255,255,0.5),
                inset 5px 5px 10px rgba(0,0,0,0.2);
  }
  .candle { 
    width: 8px; height: 30px; background: #fff; 
    position: absolute; bottom: 100%; border-radius: 2px; 
  }
  .flame { 
    width: 10px; height: 10px; background: gold; border-radius: 50%; 
    position: absolute; top: -12px; left: -1px; 
    box-shadow: 0 0 15px gold; 
    animation: flicker 0.2s infinite alternate;
  }
  @keyframes flicker {
    from { transform: scale(1) translateY(0px); opacity:1; }
    to { transform: scale(1.2) translateY(-2px); opacity:0.8; }
  }
  #linkDisplay { display: none; } /* keep hidden */
  #message {
    display: none; font-size: 20px; color: #333; text-align: center;
  }
</style>
</head>
<body>
<div id="cake">
  <div id="frosting"></div>
</div>
<div id="message">üßö‚Äç‚ôÄÔ∏è The fairies have gotten your wishes üßö‚Äç‚ôÄÔ∏è</div>
<div id="linkDisplay"></div> <!-- hidden but keeps URL functionality -->
<script>
const cake = document.getElementById('cake');
const message = document.getElementById('message');
let candles = [];
let blownOut = false;

// Read candles from URL
const params = new URLSearchParams(window.location.search);
const candleStr = params.get('candles');
if (candleStr) {
  candles = candleStr.split(',').map(pos => parseFloat(pos));
  drawCandles();
}

// Add candle on click
cake.addEventListener('click', e => {
  const rect = cake.getBoundingClientRect();
  const xPercent = ((e.clientX - rect.left) / rect.width) * 100;
  candles.push(xPercent);
  blownOut = false; 
  message.style.display = 'none';
  updateURL();
  drawCandles();
});

function drawCandles() {
  cake.querySelectorAll('.candle').forEach(el => el.remove());
  candles.forEach(x => {
    const c = document.createElement('div');
    c.className = 'candle';
    c.style.left = `calc(${x}% - 4px)`;
    if (!blownOut) {
      const flame = document.createElement('div');
      flame.className = 'flame';
      c.appendChild(flame);
    }
    cake.appendChild(c);
  });
}

function updateURL() {
  const str = candles.map(x => x.toFixed(1)).join(',');
  const newUrl = window.location.origin + window.location.pathname + '?candles=' + str;
  window.history.replaceState({}, '', newUrl);
}

// Blow detection
async function setupMic() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioCtx.createMediaStreamSource(stream);
    const analyser = audioCtx.createAnalyser();
    source.connect(analyser);
    const data = new Uint8Array(analyser.fftSize);

    function checkVolume() {
      analyser.getByteTimeDomainData(data);
      let sum = 0;
      for (let i = 0; i < data.length; i++) {
        sum += Math.abs(data[i] - 128);
      }
      const volume = sum / data.length;
      if (volume > 10 && !blownOut) {
        blownOut = true;
        drawCandles();
        message.style.display = 'block';
      }
      requestAnimationFrame(checkVolume);
    }
    checkVolume();
  } catch (err) {
    console.error('Mic access denied or error:', err);
  }
}
setupMic();
</script>
</body>
</html>
